<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEPTUNE CRM v13.0 // OCCAM'S RAZOR</title>
    <style>
        :root {
            --bg-color: #050505;
            --main-color: #00ff00;
            --dim-color: #005500;
            --alert-color: #ff3333;
            --frozen-color: #00ffff;
            --ai-color: #ff00ff;
            --private-color: #ffaa00; 
            --border-style: 2px solid var(--main-color);
            --font-stack: 'Courier New', Courier, monospace;
            font-size: 16px; 
        }

        * { box-sizing: border-box; }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: #001100; border-left: 1px solid var(--dim-color); }
        ::-webkit-scrollbar-thumb { background: var(--dim-color); border: 2px solid #000; border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--main-color); }

        body {
            background-color: var(--bg-color);
            color: var(--main-color);
            font-family: var(--font-stack);
            margin: 0;
            padding: 10px;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        .dashboard-header {
            display: grid; grid-template-columns: 1fr 1fr 1fr 1.5fr; gap: 10px;
            margin-bottom: 10px; border-bottom: var(--border-style); padding-bottom: 5px;
            flex-shrink: 0; height: 70px;
        }
        .stat-card { border: 1px solid var(--dim-color); padding: 5px; text-align: center; background: rgba(0, 20, 0, 0.3); }
        .stat-value { font-size: 1.4rem; font-weight: bold; line-height: 1.1; } 
        .stat-label { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; }

        /* --- Main Layout --- */
        .main-container {
            display: grid; 
            grid-template-columns: 240px 1fr 480px; 
            gap: 15px;
            flex: 1; 
            min-height: 0; 
            overflow: hidden;
        }

        .panel-box {
            border: var(--border-style);
            display: flex; flex-direction: column;
            background: #000;
            overflow: hidden; 
            height: 100%;
        }

        /* --- Sidebar --- */
        .tactical-sidebar { @extend .panel-box; }
        .sidebar-content { overflow-y: auto; flex: 1; padding: 10px; }
        .section-title { border-bottom: 1px solid var(--main-color); padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; font-size: 1rem; background: #002200; padding: 5px;}
        
        .tactic-btn {
            display: block; width: 100%; background: transparent; color: var(--main-color);
            border: 1px dashed var(--dim-color); padding: 10px; margin-bottom: 10px;
            text-align: left; cursor: pointer; font-family: var(--font-stack); transition: 0.1s;
            line-height: 1.4; font-size: 0.85rem;
        }
        .tactic-btn:hover { background: var(--main-color); color: #000; font-weight: bold; }

        /* --- Fishpond --- */
        .fishpond-panel { @extend .panel-box; }
        .search-bar-container { padding: 10px; border-bottom: 1px solid var(--dim-color); display: flex; gap: 10px; flex-shrink: 0; }
        #search-input { flex: 1; background: #001100; border: 1px solid var(--main-color); color: var(--main-color); padding: 8px; font-size: 1rem; }
        .table-wrapper { overflow-y: auto; flex: 1; padding: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { position: sticky; top: 0; background: #002200; border-bottom: 1px solid var(--main-color); padding: 10px; text-align: left; z-index: 10; font-weight: bold;}
        td { padding: 10px; border-bottom: 1px solid var(--dim-color); vertical-align: middle; }
        tr:hover { background: rgba(0, 255, 0, 0.2); }
        .selected-row { background: rgba(0, 255, 0, 0.3) !important; border-left: 5px solid #fff; }

        /* --- AI Panel --- */
        .ai-panel { 
            border: 2px solid var(--ai-color); 
            display: flex; flex-direction: column; 
            background: rgba(20, 0, 20, 0.2);
            height: 100%; 
            position: relative;
        }
        
        .ai-header { 
            color: var(--ai-color); font-weight: bold; border-bottom: 1px solid var(--ai-color);
            padding: 8px; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
            background: #100010;
        }

        #strategy-select {
            background: #000; color: var(--ai-color); border: 1px solid var(--ai-color);
            font-family: var(--font-stack); font-size: 0.9rem; padding: 5px;
            cursor: pointer; font-weight: bold;
        }

        .target-info-bar {
            padding: 5px 10px; font-size: 0.8rem; color: #666; background: #000; 
            border-bottom: 1px solid #220022; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }

        #chat-history { 
            flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 20px; scroll-behavior: smooth;
            min-height: 0; 
        }

        .ai-footer-area {
            flex-shrink: 0; border-top: 1px solid var(--ai-color);
            padding: 10px; background: #000; display: flex; gap: 10px; flex-direction: column;
        }

        .ai-input-wrapper { display: flex; gap: 10px; height: 60px; }
        #ai-prompt { 
            flex: 1; background: #050505; border: 1px solid var(--ai-color); color: var(--ai-color); 
            padding: 10px; resize: none; font-family: var(--font-stack); font-size: 1rem;
        }
        #btn-send-ai { 
            width: 70px; background: var(--ai-color); color: #000; border: none; 
            font-weight: bold; cursor: pointer; font-size: 0.9rem;
        }
        #btn-send-ai:hover { opacity: 0.8; }

        .msg-user { color: var(--main-color); margin: 10px 0; text-align: right; border-right: 3px solid var(--main-color); padding-right: 10px; }
        .msg-ai { color: var(--ai-color); margin: 10px 0; text-align: left; white-space: pre-wrap; border-left: 3px solid var(--ai-color); padding-left: 10px; background: rgba(255,0,255,0.05); padding: 10px; }
        .msg-sys { color: #888; font-size: 0.8em; text-align: center; margin: 15px 0; font-style: italic; border-top: 1px dashed #333; padding-top: 5px;}
        .loading-blink { animation: blink 1s infinite; color: var(--ai-color); font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* --- Footer (Global) --- */
        .global-input-bar {
            margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr 0.8fr 1fr 1fr auto 1fr;
            gap: 10px; border-top: var(--border-style); padding-top: 10px; align-items: center;
            flex-shrink: 0; height: 50px;
        }

        /* --- Modal --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #000; border: 2px solid var(--main-color); width: 800px; max-width: 95%; max-height: 90vh; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .dual-memo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .memo-box textarea { width: 100%; height: 150px; background: #111; color: #ddd; border: 1px solid #333; padding: 10px; font-size: 1rem; }
        
        /* Controls */
        .action-btn { background: var(--main-color); color: #000; border: none; padding: 5px 15px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .action-btn.secondary { background: transparent; color: var(--main-color); border: 1px solid var(--main-color); }
        select, input { background: transparent; color: var(--main-color); border: 1px solid var(--dim-color); padding: 5px; font-size: 1rem; }
        #file-input { display: none; }
        
        .inject-label { cursor: pointer; display: flex; align-items: center; gap: 5px; user-select: none; border: 1px solid #333; padding: 2px 8px; color: #888; }
        .inject-label input { display: none; }
        .inject-label.active { background: var(--ai-color); color: #000; border-color: var(--ai-color); }

        /* --- ğŸ“± v13.2 æ‰‹æœºç«¯å‚ç›´æµé‡æ„ (Vertical Flow) --- */
        @media (max-width: 768px) {
            /* 1. å…¨å±€è§£ç¦ï¼šå…è®¸æ— é™æ»šåŠ¨ */
            body { 
                height: auto !important; 
                overflow-y: auto !important; 
                display: block !important; /* è§£é™¤Flexé”æ­» */
                padding: 10px;
            }

            /* 2. å¤´éƒ¨ï¼šä¿æŒåŸæ ·ï¼Œä½†å…è®¸å‹ç¼© */
            .dashboard-header {
                display: flex;
                flex-wrap: wrap;
                height: auto !important;
                gap: 5px;
                margin-bottom: 15px;
            }
            .stat-card { flex: 1 1 45%; font-size: 0.8rem; } /* ç»Ÿè®¡å¡ç‰‡å˜å° */

            /* 3. æ ¸å¿ƒå®¹å™¨ï¼šæ”¹ä¸ºå‚ç›´å †å ï¼Œå¹¶å¯ç”¨â€œæ´—ç‰Œâ€åŠŸèƒ½ */
            .main-container {
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
                overflow: visible !important;
                gap: 20px;
            }

            /* --- 4. ä¹¾å¤å¤§æŒªç§» (åˆ©ç”¨ order å±æ€§é‡æ’é¡ºåº) --- */
            
            /* ä¼˜å…ˆçº§ Aï¼šAI æŒ‡æŒ¥ä¸­å¿ƒ (æ ¸å¿ƒ) */
            .ai-panel {
                order: 1; 
                height: 600px !important; /* ç»™è¶³é«˜åº¦ï¼Œè®©ä½ èŠä¸ªçˆ½ */
                min-height: 600px;
                overflow: hidden; /* å†…éƒ¨èŠå¤©è®°å½•æ»šåŠ¨ */
                border: 2px solid var(--ai-color);
                margin-bottom: 20px;
            }

            /* ä¼˜å…ˆçº§ Bï¼šé±¼å¡˜åˆ—è¡¨ */
            .fishpond-panel {
                order: 2;
                height: 500px !important;
                min-height: 500px;
            }

            /* ä¼˜å…ˆçº§ Cï¼šæˆ˜æœ¯å†›ç«åº“ (æ”¾åœ¨åé¢ï¼Œéœ€è¦æ—¶å†æ»‘ä¸‹æ¥) */
            .tactical-sidebar {
                order: 3;
                height: auto !important;
                max-height: 400px;
            }

            /* 5. åº•éƒ¨å½•å…¥æ ï¼šå˜æˆç«–æ’ï¼Œæ”¾åœ¨æœ€ä¸‹é¢ */
            .global-input-bar {
                margin-top: 30px;
                display: flex;
                flex-direction: column;
                height: auto !important;
                gap: 15px;
                padding-bottom: 50px; /* åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«æ‰‹æœºHomeæ¡æŒ¡ä½ */
            }
            .global-input-bar input, 
            .global-input-bar select, 
            .global-input-bar button {
                width: 100%;
                height: 45px; /* æ‰‹æŒ‡å¥½ç‚¹ */
                font-size: 1rem;
            }
            
            /* 6. éšè—ä¸å¿…è¦çš„è£…é¥° */
            .date-arrow-hint { display: none; }
            
            /* 7. ä¿®å¤å¼¹çª—åœ¨æ‰‹æœºä¸Šçš„æ˜¾ç¤º */
            .modal-content {
                width: 95% !important;
                height: 80vh !important;
                margin-top: 10vh;
            }
            .dual-memo-grid {
                grid-template-columns: 1fr !important; /* æ¡£æ¡ˆå¡ä¹Ÿå˜å•æ  */
            }
        }
    </style>
</head>
<body>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #0f0; padding-bottom:10px">
                <h2 style="margin:0">>> æ¡£æ¡ˆè¯¦æƒ…</h2>
                <button class="action-btn secondary" onclick="closeModal()">ESC å…³é—­</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-id">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px">
                    <div><label>ä»£å·</label><input type="text" id="modal-name" style="width:100%"></div>
                    <div><label>é¢œå€¼</label><input type="text" id="modal-looks" style="width:100%"></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:10px">
                    <div><label>é˜¶æ®µ</label><select id="modal-stage" style="width:100%"><option>åˆšè®¤è¯†</option><option>æš§æ˜§</option><option>é‚€çº¦</option><option>å·²æ‹¿ä¸‹</option></select></div>
                    <div><label>æ¥æº</label><input type="text" id="modal-source" style="width:100%"></div>
                </div>
                <div style="margin-top:15px">
                    <label style="color:var(--alert-color)">è”ç³»æ—¥æœŸ (æ ¡å‡†)</label>
                    <input type="date" id="modal-lastContact" style="width:100%; margin-top:5px; color-scheme:dark;">
                </div>

                <div class="dual-memo-grid">
                    <div class="memo-box" style="border:1px solid var(--ai-color); padding:10px">
                        <label style="color:var(--ai-color); font-weight:bold">æˆ˜æœ¯æƒ…æŠ¥ (AIå¯è§)</label>
                        <textarea id="modal-ai-memo" placeholder="ä¾‹å¦‚ï¼šæ€§æ ¼æ…¢çƒ­ï¼Œå–œæ¬¢æ—¥æ–™..."></textarea>
                    </div>
                    <div class="memo-box" style="border:1px solid var(--private-color); padding:10px">
                        <label style="color:var(--private-color); font-weight:bold">ç»å¯†æ¡£æ¡ˆ (æœ¬åœ°ä»…è§)</label>
                        <textarea id="modal-private-memo" placeholder="çœŸå/åœ°å€/é»‘å†å²..."></textarea>
                    </div>
                </div>
            </div>
            <div style="margin-top:20px; text-align:right; border-top:1px solid #050; padding-top:10px">
                <button class="action-btn secondary" style="color:var(--alert-color); border-color:var(--alert-color)" onclick="deleteFromModal()">åˆ é™¤</button>
                <button class="action-btn" onclick="saveModalData()">[ ä¿å­˜ ]</button>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal-overlay">
        <div class="modal-content" style="border-color:var(--ai-color); width:500px">
            <h3 style="color:var(--ai-color)">>> AI è¿æ¥é…ç½®</h3>
            <div style="margin-bottom:15px">
                <label style="color:var(--ai-color)">AI å‚å•†</label>
                <select id="cfg-provider" style="width:100%" onchange="toggleProviderSettings()">
                    <option value="google">Google Gemini (å…è´¹/æ¨è)</option>
                    <option value="openai">OpenAI / DeepSeek</option>
                </select>
            </div>
            <div id="div-url" style="margin-bottom:15px; display:none">
                <label style="color:var(--ai-color)">API Endpoint</label>
                <input type="text" id="cfg-url" style="width:100%">
            </div>
            <div style="margin-bottom:15px">
                <label style="color:var(--ai-color)">API Key</label>
                <input type="password" id="cfg-key" placeholder="ç²˜è´´å¯†é’¥..." style="width:100%">
            </div>
            <div style="margin-bottom:15px">
                <label style="color:var(--ai-color)" id="lbl-model">Model Name</label>
                <input type="text" id="cfg-model" value="gemini-2.5-flash" style="width:100%">
            </div>
            <div style="text-align:right">
                <button class="action-btn" style="background:var(--ai-color); color:#000" onclick="saveAIConfig()">æ¿€æ´»</button>
                <button class="action-btn secondary" style="border-color:var(--ai-color); color:var(--ai-color)" onclick="closeConfig()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <header class="dashboard-header">
        <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">æ€»é±¼è‹—</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-conversion">0%</div><div class="stat-label">è½¬åŒ–ç‡</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-urgent" style="color: var(--alert-color)">0</div><div class="stat-label">æ€¥éœ€ç»´æŠ¤</div></div>
        <div class="stat-card" style="display:flex; flex-direction:column; justify-content:center; gap:5px;">
             <button class="action-btn secondary" onclick="exportJSON()">å¤‡ä»½</button>
             <button class="action-btn secondary" onclick="document.getElementById('file-input').click()">å¯¼å…¥</button>
             <input type="file" id="file-input" accept=".json" onchange="importJSON(this)">
             <button class="action-btn secondary" style="border-color:var(--alert-color); color:var(--alert-color)" onclick="clearStorage()">æ ¼å¼åŒ–</button>
        </div>
    </header>

    <div class="main-container">
        <aside class="panel-box">
            <div class="section-title">>> æˆ˜æœ¯å†›ç«åº“</div>
            <div class="sidebar-content" id="arsenal-container"></div>
            <div style="padding:10px; color:var(--ai-color); font-size:0.8rem; border-top:1px dashed var(--ai-color); background:#100010; flex-shrink: 0;">
                AIçŠ¶æ€: <span id="ai-status">ç¦»çº¿</span> <a href="#" onclick="openConfig()" style="color:var(--ai-color); margin-left:10px">[é…ç½®]</a>
            </div>
        </aside>

        <section class="fishpond-panel">
            <div class="search-bar-container">
                <input type="text" id="search-input" placeholder="æœç´¢ä»£å·..." onkeyup="renderDashboard()">
                <button class="action-btn secondary" onclick="resetSelection()">é‡ç½®</button>
            </div>
            <div class="table-wrapper">
                <table id="target-table">
                    <thead><tr><th>ä»£å·</th><th>é¢œå€¼</th><th>é˜¶æ®µ</th><th>ä¸Šæ¬¡è”ç³»</th><th>çŠ¶æ€</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </section>

        <aside class="ai-panel">
            <div class="ai-header">
                <span>>> æŒ‡æŒ¥ä¸­å¿ƒ</span>
                <select id="strategy-select">
                    <option value="badboy">ğŸ˜ˆ æµªå­ (BadBoy)</option>
                    <option value="prize">ğŸ’ å¥–å“ (Prize)</option>
                </select>
            </div>
            
            <div class="target-info-bar">
                <div>
                    é”å®š: <span id="selected-target-name" style="color:var(--main-color); font-weight:bold">æœªé”å®š</span>
                </div>
                <label class="inject-label" id="inject-label">
                    <input type="checkbox" id="inject-toggle" onchange="toggleInjection()">
                    <span>ğŸ’‰ æ³¨å…¥æƒ…æŠ¥</span>
                </label>
            </div>
            
            <div id="chat-history">
                <div class="msg-sys">ç³»ç»Ÿå°±ç»ªã€‚<br>Gemini 2.5 Flash è£…è½½ã€‚<br>æ¨¡å¼ç²¾ç®€å®Œæ¯•ï¼šä»…ä¿ç•™æµªå­ä¸å¥–å“ã€‚</div>
            </div>

            <div class="ai-footer-area">
                <div class="ai-input-wrapper">
                    <textarea id="ai-prompt" placeholder="ä¾‹å¦‚ï¼šå¥¹å›äº†ä¸ªè¡¨æƒ…åŒ…ï¼Œæ€ä¹ˆå›ï¼Ÿ (Ctrl+Enter)" onkeydown="if(event.ctrlKey&&event.key==='Enter') sendToAI()"></textarea>
                    <button id="btn-send-ai" onclick="sendToAI()">å‘é€</button>
                </div>
            </div>
        </aside>
    </div>

    <footer class="global-input-bar">
        <input type="text" id="in-name" placeholder="ä»£å·">
        <input type="text" id="in-source" placeholder="æ¥æº">
        <input type="text" id="in-looks" placeholder="é¢œå€¼">
        <select id="in-stage"><option>åˆšè®¤è¯†</option><option>æš§æ˜§</option><option>é‚€çº¦</option><option>å·²æ‹¿ä¸‹</option></select>
        <input type="date" id="in-time" style="color-scheme:dark">
        <div class="date-arrow-hint">â† æ”¹æœŸ</div>
        <button class="action-btn" onclick="addTarget()">>> å½•å…¥</button>
    </footer>

    <script>
        const DB_KEY = 'neptune_crm_v13_db';
        const AI_CONF_KEY = 'neptune_ai_config_v13';
        
        const tactics = [
            { label: "æ‰“å‹ (Neg)", text: "ä½ è¿™è‡ªæ‹ä¿®å¾—ä¸é”™ï¼Œæœ¬äººåº”è¯¥æ›´è‡ªç„¶ç‚¹å§ï¼Ÿ" },
            { label: "æ¨æ‹‰ (Push/Pull)", text: "åˆšè§‰å¾—ä½ æŒºèªæ˜çš„ï¼Œè¿™å¥è¯åˆæš´éœ²äº†ä½ çš„æ†¨æ†¨å±æ€§ã€‚" },
            { label: "èµ‹æ ¼ (Framing)", text: "çœ‹æ¥ä½ æ˜¯ä¸€ä¸ªå¯¹ç”Ÿæ´»å“è´¨å¾ˆæœ‰è¦æ±‚çš„äººï¼Œä¸æ„¿å°†å°±ã€‚" },
            { label: "å†·è¯» (Cold Read)", text: "è¡¨é¢çœ‹ä½ æœ‹å‹å¾ˆå¤šï¼Œå…¶å®åªæœ‰æå°‘æ•°äººèƒ½èµ°è¿›ä½ å¿ƒé‡Œã€‚" },
            { label: "é‚€çº¦ (Close)", text: "åˆ«åœ¨é‚£çŒœäº†ï¼Œå‘¨äº”å¸¦ä½ å»ä¸ªåœ°æ–¹ï¼Œè§é¢èŠã€‚" }
        ];

        // --- å¥¥å¡å§†å‰ƒåˆ€ï¼šåªä¿ç•™æœ€æ ¸å¿ƒçš„ ---
        const STRATEGIES = {
            'badboy': "è§’è‰²ï¼šé¡¶çº§æƒ…æ„Ÿç§æ•™ã€‚å½“å‰ç­–ç•¥ï¼šã€æµªå­æ¨¡å¼ (Bad Boy)ã€‘ã€‚æ ¸å¿ƒç‰¹è´¨ï¼šæ— æ‰€è°“ï¼ˆOutcome Independenceï¼‰ã€å¹½é»˜ã€ä¸å¯é¢„æµ‹ã€æ¨æ‹‰ã€‚ä½ çš„ä»»åŠ¡ï¼šå¸®ç”¨æˆ·å†™ä¸€å¥å›å¤ã€‚ä¸è¦åƒä¸ªå®¢æœä¸€æ ·è¯´è¯ã€‚å›å¤è¦å¸¦æœ‰ä¾µç•¥æ€§å’ŒæŒ‘é€—æ€§ï¼Œå»ºç«‹å¥–å“æ¡†æ¶ã€‚å¦‚æœå¯¹æ–¹å†·æ·¡ï¼Œä½ å°±æ›´å†·æ·¡æˆ–è€…è°ƒä¾ƒå¥¹ã€‚è®©å¥¹è§‰å¾—å¥¹åœ¨è¿½é€ä½ ã€‚é™„å¸¦ç®€çŸ­æˆ˜æœ¯æ„å›¾ã€‚",
            
            'prize': "è§’è‰²ï¼šé¡¶çº§æƒ…æ„Ÿç§æ•™ã€‚å½“å‰ç­–ç•¥ï¼šã€å¥–å“æ¨¡å¼ (Prize)ã€‘ã€‚æ ¸å¿ƒç‰¹è´¨ï¼šé«˜ä»·å€¼ã€ç­›é€‰ã€ç¨€ç¼ºæ€§ã€‚ä½ çš„ä»»åŠ¡ï¼šå¸®ç”¨æˆ·å†™ä¸€å¥å›å¤ã€‚å›å¤ä¸­è¦æš—ç¤ºä½ ç”Ÿæ´»ä¸°å¯Œã€å¾ˆå¿™ã€æœ‰æ ‡å‡†ã€‚ä¸è¦ç›´æ¥å›ç­”å¥¹çš„é—®é¢˜ï¼Œè¦åé—®æˆ–è¯„ä»·å¥¹ã€‚å¦‚æœå¥¹è¡¨ç°ä¸å¥½ï¼Œæ’¤å›æ³¨æ„åŠ›ã€‚ç”¨é€»è¾‘æ¸…æ™°çš„æ–¹å¼è§£é‡Šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå›ï¼ˆåƒè§£æ•°å­¦é¢˜ä¸€æ ·ï¼‰ã€‚"
        };

        let targets = JSON.parse(localStorage.getItem(DB_KEY)) || [];
        let aiConfig = JSON.parse(localStorage.getItem(AI_CONF_KEY)) || { 
            provider: "google", 
            url: "", 
            key: "", 
            model: "gemini-2.5-flash" 
        };
        let currentTargetId = null;
        let injectEnabled = false;

        window.onload = function() {
            document.getElementById('in-time').value = new Date().toISOString().split('T')[0];
            renderArsenal();
            renderDashboard();
            updateAIStatus();
            toggleProviderSettings();
        };

        // UI Renders
        function renderArsenal() {
            document.getElementById('arsenal-container').innerHTML = tactics.map(t => 
                `<button class="tactic-btn" onclick="copyText('${t.text}')">
                    <span style="font-weight:bold; color:#0f0">[ ${t.label} ]</span><br>
                    <span style="opacity:0.7">${t.text}</span>
                </button>`
            ).join('');
        }

        function renderDashboard() {
            const filter = document.getElementById('search-input').value.toLowerCase();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const sorted = targets.filter(t => t.name.toLowerCase().includes(filter))
                .sort((a,b) => getCooldownStatus(a.lastContact).v - getCooldownStatus(b.lastContact).v);

            sorted.forEach(t => {
                const status = getCooldownStatus(t.lastContact);
                const d = new Date(t.lastContact);
                const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                const isSelected = t.id === currentTargetId ? 'selected-row' : '';
                tbody.innerHTML += `
                    <tr class="${isSelected}" onclick="selectTarget(${t.id})">
                        <td class="name-cell" onclick="event.stopPropagation(); openModal(${t.id})">${t.name}</td>
                        <td>${t.looks}</td><td>${t.stage}</td><td>${dateStr}</td>
                        <td class="${status.class}">${status.text}</td>
                    </tr>`;
            });
            
            document.getElementById('stat-total').innerText = targets.length;
            document.getElementById('stat-urgent').innerText = targets.filter(t => getCooldownStatus(t.lastContact).class === 'status-alert').length;
            const closed = targets.filter(t => t.stage === 'å·²æ‹¿ä¸‹').length;
            document.getElementById('stat-conversion').innerText = (targets.length ? (closed/targets.length*100).toFixed(1) : 0) + '%';
        }

        function getCooldownStatus(lastContactTime) {
            const diffHours = (Date.now() - lastContactTime) / 36e5;
            if (diffHours > 24) return { text: "âš ï¸", class: "status-alert", v: 0 }; 
            if (diffHours < 3) return { text: "â„ï¸", class: "status-frozen", v: 2 }; 
            return { text: "â—", class: "status-normal", v: 1 };
        }

        // Core Actions
        function addTarget() {
            const name = document.getElementById('in-name').value;
            if(!name) return alert("ä»£å·å¿…å¡«");
            const dateInput = document.getElementById('in-time').value;
            const finalTime = (dateInput === new Date().toISOString().split('T')[0]) ? Date.now() : new Date(dateInput + 'T12:00:00').getTime();

            targets.push({
                id: Date.now(), name, source: document.getElementById('in-source').value||"?",
                looks: document.getElementById('in-looks').value||"?", stage: document.getElementById('in-stage').value,
                ai_memo: "", private_memo: "", lastContact: finalTime
            });
            saveData();
            document.getElementById('in-name').value = ''; 
        }

        function selectTarget(id) {
            if(currentTargetId !== id) {
                document.getElementById('chat-history').innerHTML = '<div class="msg-sys">ä¼šè¯å·²é‡ç½®ã€‚æ–°ç›®æ ‡å·²é”å®šã€‚</div>';
            }
            currentTargetId = id;
            const t = targets.find(i => i.id === id);
            renderDashboard();
            document.getElementById('selected-target-name').innerText = `${t.name}`;
            if(injectEnabled) {
                document.getElementById('inject-label').classList.add('active');
            }
        }

        function resetSelection() {
            currentTargetId = null; renderDashboard();
            document.getElementById('selected-target-name').innerText = "æœªé”å®š";
            document.getElementById('chat-history').innerHTML += '<div class="msg-sys">ç›®æ ‡å·²è§£é”ã€‚</div>';
        }
        
        function toggleInjection() {
            injectEnabled = document.getElementById('inject-toggle').checked;
            document.getElementById('inject-label').classList.toggle('active', injectEnabled);
        }

        function saveData() { localStorage.setItem(DB_KEY, JSON.stringify(targets)); renderDashboard(); }

        // Modal Logic
        const modal = document.getElementById('profile-modal');
        function openModal(id) {
            const t = targets.find(i => i.id === id);
            if(!t) return;
            document.getElementById('modal-id').value = t.id;
            document.getElementById('modal-name').value = t.name;
            document.getElementById('modal-looks').value = t.looks;
            document.getElementById('modal-stage').value = t.stage;
            document.getElementById('modal-source').value = t.source;
            document.getElementById('modal-lastContact').value = new Date(t.lastContact).toISOString().split('T')[0];
            document.getElementById('modal-ai-memo').value = t.ai_memo || "";
            document.getElementById('modal-private-memo').value = t.private_memo || "";
            modal.style.display = 'flex';
        }
        function closeModal() { modal.style.display = 'none'; }
        function saveModalData() {
            const id = parseInt(document.getElementById('modal-id').value);
            const t = targets.find(i => i.id === id);
            if(t) {
                t.name = document.getElementById('modal-name').value;
                t.looks = document.getElementById('modal-looks').value;
                t.stage = document.getElementById('modal-stage').value;
                t.source = document.getElementById('modal-source').value;
                t.ai_memo = document.getElementById('modal-ai-memo').value;
                t.private_memo = document.getElementById('modal-private-memo').value;
                const dVal = document.getElementById('modal-lastContact').value;
                if(dVal !== new Date(t.lastContact).toISOString().split('T')[0]) {
                     t.lastContact = new Date(dVal + 'T12:00:00').getTime();
                }
                saveData(); closeModal();
            }
        }
        function deleteFromModal() {
            if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) {
                targets = targets.filter(t => t.id != document.getElementById('modal-id').value);
                saveData(); closeModal();
                resetSelection();
            }
        }

        // AI & Config
        function openConfig() { 
            document.getElementById('config-modal').style.display = 'flex';
            document.getElementById('cfg-provider').value = aiConfig.provider || 'google';
            document.getElementById('cfg-url').value = aiConfig.url;
            document.getElementById('cfg-key').value = aiConfig.key;
            document.getElementById('cfg-model').value = aiConfig.model || "gemini-2.5-flash"; 
            toggleProviderSettings();
        }
        function closeConfig() { document.getElementById('config-modal').style.display = 'none'; }
        
        function toggleProviderSettings() {
            const provider = document.getElementById('cfg-provider').value;
            const divUrl = document.getElementById('div-url');
            if(provider === 'google') {
                divUrl.style.display = 'none';
                if(!document.getElementById('cfg-model').value) document.getElementById('cfg-model').value = "gemini-2.5-flash";
            } else {
                divUrl.style.display = 'block';
            }
        }

        function saveAIConfig() {
            aiConfig.provider = document.getElementById('cfg-provider').value;
            aiConfig.url = document.getElementById('cfg-url').value.trim();
            aiConfig.key = document.getElementById('cfg-key').value.trim();
            aiConfig.model = document.getElementById('cfg-model').value.trim();
            localStorage.setItem(AI_CONF_KEY, JSON.stringify(aiConfig));
            updateAIStatus(); closeConfig();
        }
        function updateAIStatus() {
            const s = document.getElementById('ai-status');
            s.innerText = (aiConfig.key.length > 5) ? "åœ¨çº¿" : "ç¦»çº¿";
            s.style.color = (aiConfig.key.length > 5) ? "#0f0" : "#666";
        }

        function appendMsg(role, text) {
            const box = document.getElementById('chat-history');
            const d = document.createElement('div');
            d.className = role==='user'?'msg-user':(role==='ai'?'msg-ai':'msg-sys');
            d.innerHTML = text;
            box.appendChild(d); 
            box.scrollTop = box.scrollHeight;
        }

        async function sendToAI() {
            const input = document.getElementById('ai-prompt');
            const txt = input.value.trim();
            if(!txt) return;
            if(!aiConfig.key) return alert("AI æœªé…ç½®");
            
            input.value = '';
            appendMsg('user', txt);
            
            const loadingId = 'loading-' + Date.now();
            appendMsg('sys', `<span id="${loadingId}" class="loading-blink">[ç³»ç»Ÿ] æ­£åœ¨è”ç»œ AI...</span>`);
            
            let context = "";
            const mode = document.getElementById('strategy-select').value;
            let sysMsg = STRATEGIES[mode] || STRATEGIES['badboy']; // Default to BadBoy

            if(currentTargetId && injectEnabled) {
                const t = targets.find(i => i.id === currentTargetId);
                context = `\n[èƒŒæ™¯æƒ…æŠ¥] é˜¶æ®µ:${t.stage}, å¤‡æ³¨:${t.ai_memo || "æ— "}`;
                const modeName = document.getElementById('strategy-select').selectedOptions[0].text;
                document.getElementById(loadingId).innerText = `[ç³»ç»Ÿ] æ³¨å…¥${modeName}...`;
            }

            const fullPrompt = `${sysMsg} ${context} \nç”¨æˆ·é—®é¢˜: ${txt}`;

            try {
                if(aiConfig.provider === 'google') {
                    const model = aiConfig.model || 'gemini-2.5-flash';
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${aiConfig.key}`;
                    
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                    });
                    const data = await res.json();
                    document.getElementById(loadingId).remove();

                    if(data.error) throw new Error(data.error.message);
                    const reply = data.candidates[0].content.parts[0].text;
                    appendMsg('ai', reply);

                } else {
                    const res = await fetch(aiConfig.url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${aiConfig.key}` },
                        body: JSON.stringify({
                            model: aiConfig.model,
                            messages: [{ role: "user", content: fullPrompt }],
                            temperature: 0.7
                        })
                    });
                    const data = await res.json();
                    document.getElementById(loadingId).remove();
                    
                    if(data.error) throw new Error(data.error.message);
                    appendMsg('ai', data.choices[0].message.content);
                }
            } catch(e) { 
                const loader = document.getElementById(loadingId);
                if(loader) loader.innerHTML = `<span style="color:red">é”™è¯¯: ${e.message}</span>`;
            }
        }
        
        function copyText(t) { navigator.clipboard.writeText(t).then(()=>alert("å·²å¤åˆ¶")); }
        function exportJSON() {
            const a = document.createElement("a");
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(targets));
            a.download = `neptune_v13_${Date.now()}.json`; a.click();
        }
        function importJSON(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = e => { if(confirm("è¦†ç›–æ•°æ®?")) { targets = JSON.parse(e.target.result); saveData(); }};
            r.readAsText(f);
        }
        function clearStorage() { if(confirm("æ¸…é™¤æ‰€æœ‰?")) { localStorage.removeItem(DB_KEY); targets=[]; renderDashboard(); }}
    </script>
</body>
</html>